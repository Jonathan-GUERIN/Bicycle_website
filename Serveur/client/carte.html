<!DOCTYPE html>
<head>
	<title>Carte</title>
	<link rel="stylesheet" type="text/css" href="css/leaflet.css" /> 
	<link rel="stylesheet" type="text/css" href="css/style.css"/>
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
	<script src="leaflet.js"> // insertion bibliothèque Leaflet : http://leafletjs.com/ </script>
	<meta charset="utf-8">
</head>


<body onload="load_data()">  <!-- Récupération des données avec le chargement de la page -->
	
	<header class="nav">
		<img src=images/logo_velov.png>
		<nav>
			<button type="button" onclick="window.location.href = 'index.html';"> Accueil </button>
			<button type="button" onclick="window.location.href = 'carte.html';"> Carte </button>
		</nav>
		<img src=images/logo_metropole.png>
	</header>
	<section class="cartestation">
		<h1>Disponibilité des vélo'v</h1>

		<div id="map"></div>  
		<div class="recherche">
			<fieldset>
				<input id='datedebut' type="datetime" value='2020-12-25'>
				<input id='datefin' type="datetime" value='2020-12-25'>
				<input id='pas' type="radio" value = '5min'>
			</fieldset>

			<h3>Stations sélectionnées</h3>
			<p id="erreurstat">Vous devez sélectionner au moins une station</p>
			<p id="selectstation"></p>
			<button onclick="Affichegraphe()">Afficher graphe</button>
		</div>

		<div id="graphe">
		</div>
	</section>
</body>



<script>
	// Creation d'une carte dans la balise div "map", et positionne la vue sur un point donné et un niveau de zoom
	var map = L.map('map').setView([45.755,4.85], 12);
	// Ajout d'une couche de dalles OpenStreetMap
	L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);
	
	function load_data () {
		var xhr = new XMLHttpRequest();
		xhr.onload = function() {   // fonction callback
		// récupération des données renvoyées par le serveur
		var data = JSON.parse(this.responseText);
		// boucle sur les enregistrements renvoyés
		for ( n = 0; n < data.length; n++ ) {
			// insertion d'un marqueur à la position, attachement d'une popup, capture de l'évènement "clic', ajout nom et id station
			L.marker([data[n].lat,data[n].lon]).addTo(map).addEventListener('click',OnMarkerClick).idstat=data[n].nom;
			}
		};
		xhr.open('GET','/stations',true);
		xhr.send();
	}	 
	
	function OnMarkerClick(e) {
		var legende = document.getElementById('selectstation');
		document.getElementById('erreurstat').setAttribute("style", "display:none;");
		legende.innerHTML += e.target.idstat+'<br>';
	}
	
	function Affichegraphe () {
		var xhr = new XMLHttpRequest(); 
		  var pas = document.getElementById('pas').value;
		  var datdeb = document.getElementById('datedebut').value;
		  var datfin = document.getElementById('datefin').value;
		  var stations = document.getElementById('selectstation').innerHTML;
		  console.log(stations)
		  if (stations!==""){ 
			  xhr.onload = function() {   // fonction callback
				// récupération des données renvoyées par le serveur
				var data = JSON.parse(this.responseText);
				// affichage du graphe
				document.getElementById('graphe').innerHTML = '<img src=' +data.linkimg+' alt=courbe de disponibilité de '+stations+'></img>';
				};
			  xhr.open('GET','/courbe?stations='+stations+'&datedebut='+datdeb+'&datefin='+datfin+'&pas='+pas,true);  // requête avec une "query string"
			  xhr.send();
			} else {
				document.getElementById('erreurstat').setAttribute("style", "display:inline;");
			}
		}
</script>